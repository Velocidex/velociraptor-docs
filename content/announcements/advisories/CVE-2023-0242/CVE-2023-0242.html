<p><span>Published</span> on 2023-01-18</p>
<details class="popup">
  <summary class="lbl rnd sec CVSS HIGH">
    CVSS · HIGH · 8.1<sub>⁄10</sub> <span style="font-size:0px;opacity:0">·
      CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:N</span>
  </summary>
  <div class="pop wht rnd shd pad bor">
    <span>Scoring scenario:</span> GENERAL
    <div>
      attackVector: <b>NETWORK</b>
    </div>
    <div>
      attackComplexity: <b>LOW</b>
    </div>
    <div>
      privilegesRequired: <b>HIGH</b>
    </div>
    <div>
      userInteraction: <b>REQUIRED</b>
    </div>
    <div>
      scope: <b>CHANGED</b>
    </div>
    <div>
      confidentialityImpact: <b>HIGH</b>
    </div>
    <div>
      integrityImpact: <b>HIGH</b>
    </div>
    <div>
      availabilityImpact: <b>NONE</b>
    </div>
    <div>
      <a class="vgi-dial" href=
         "https://cvss.js.org/#CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:N"
         target="_blank">Open CVSS Calc</a>
    </div>
  </div>
</details>
<div id="description">
  <p>Improper Privilege Management vulnerability in Rapid7
    Velociraptor in the copy() function.<br>
    <br>
    Velociraptor allows users to be created with different
    privileges on the server. Administrators are generally
    allowed to run any command on the server including writing
    arbitrary files. However, lower privilege users are generally
    forbidden from writing or modifying files on the server.<br>
    <br>
    The VQL copy() function applies permission checks for reading
    files but does not check for permission to write files. This
    allows a low privilege user (e.g. users with the Velociraptor
    "investigator" role) to overwrite files on the server,
    including Velociraptor configuration files.<br>
    <br>
    To exploit this vulnerability, the attacker must already have
    a Velociraptor user account at a low privilege level (at
    least "analyst"). Be able to log into the GUI and create a
    notebook where they can run the VQL query invoking the copy()
    VQL function. Typically most users deploy Velociraptor with
    limited access to a trusted group (most users will be
    administrators within the GUI).<br></p>
  <p>This vulnerability is associated with program files
    <tt><a target="_blank" rel="nofollow" href=
           "https://github.Com/Velocidex/velociraptor/blob/master/vql/filesystem/copy.go">
        https://github.Com/Velocidex/velociraptor/blob/master/vql/filesystem/copy.go</a></tt>
    and program routines <tt>copy()</tt>.</p>
  <p>This issue affects Velociraptor: before 0.6.7-5.</p>
</div>
<div id="configs">
  <h2>Required configuration for exposure:</h2>
  <p>Velociraptor deployment with multiple users at lower roles
    than administrators (e.g. "investigator" and above)</p>
</div>
<div id="problem">
  <h2>Problem:</h2>
  <p>CWE-269 Improper Privilege Management <a href=
                                              "https://cwe.mitre.org/data/definitions/CWE-269" target=
                                              "_blank"><small>CWE-269</small></a><br></p>
</div>
<div id="impact">
  <h2>Impact:</h2>
  <p>CAPEC-75 Manipulating Writeable Configuration Files
    <a href="https://capec.mitre.org/data/definitions/CAPEC-75"
       target="_blank"><small>CAPEC-75</small></a><br></p>
</div>
<div id="status">
  <h2>Product Status:</h2>
  <table class="striped">
    <colgroup>
      <col>
      <col class="affectedCol">
    </colgroup>
    <thead>
      <tr>
        <th>Product</th>
        <th>Affected</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="1">
          <b class="vgi-package">Rapid7 Velociraptor</b>
          <span>» VQL copy() function</span> <i>on</i>
          <span class="vgi-stack">Linux, Windows, MacOS, 64
            bit, 32 bit</span><br>
          <a class="vgi-package" href=
             "https://github.com/Velocidex/velociraptor/releases">package
            repo</a><a class="vgi-ext" href=
                       "https://github.com/Velocidex/velociraptor/">source
            repo</a><span class=
                          "vgi-text">https://github.com/Velocidex/velociraptor/blob/master/vql/filesystem/copy.go</span><span class="vgi-edit">copy()</span><br>

          <span class="vgi-impact">Default status is
            unaffected</span>
        </td>
        <td>before 0.6.7-5 (unaffected from 5)<br></td>
      </tr>
    </tbody>
  </table><br style="font-size:0;">
</div>
<div id="solution">
  <h2>Solution:</h2>
  <p>Upgrade to 0.6.7-5</p>
</div>
<div id="workaround">
  <h2>Workaround:</h2>
  <p>A valid workaround is to prevent the copy function in the
    Velociraptor allow list:<br>
    <br>
    1. In the configuration wizard answer yes to the question "Do
    you want to restrict VQL functionality on the server?"<br>
    2. This will add a default allow list to the configuration
    file.<br>
    3. Copy this allow list to your existing
    server.config.yaml<br>
    4. Ensure the "copy" function is removed from the default
    allow list.</p>
</div>
<div class="rnd pad sec vgap" id="credits">
  <h2>Credits:</h2>
  <p>Paul Alkemade from Telstra</p>
</div>
<div id="timeline">
  <h2>Timeline:</h2>
  <ul>
    <li>2023-01-12 - Notification of the issue</li>
    <li>2023-01-17 - Release 0.6.7-5 made available on
      Github</li>
  </ul>
</div>

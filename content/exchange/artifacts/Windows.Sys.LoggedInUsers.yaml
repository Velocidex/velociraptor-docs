name: Windows.Sys.LoggedInUsers
author: Zane Gittins
description: |
   Get all currently logged in users via wmi.

# Can be CLIENT, CLIENT_EVENT, SERVER, SERVER_EVENT
type: CLIENT

parameters:
   - name: UserNameRegex
     default: .
     type: string
     description: Filter by username.
   - name: DomainRegex
     default: .
     type: string
     description: Filter by domain.
   - name: LogonTypeRegex
     default: .
     type: string
     description: Filter by logon type. For example, 10 for remote.

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'

    query: |
    
        // Helper functions
        LET TimeFormat = "20060102150405.999999-0700"

        LET ExtractDomain(Antecedent) = parse_string_with_regex(string=Antecedent,regex=['Domain=\\"(.*?)\\"']).g1
        
        LET ExtractLogonName(Antecedent) = parse_string_with_regex(string=Antecedent,regex=['Name=\\"(.*)\\"']).g1
        
        LET ExtractLogonID(data) = parse_string_with_regex(string=data,regex=['LogonId=\\"([0-9]+)\\"']).g1
        
        LET FormatTime(StartTime) = timestamp(string=parse_string_with_regex(string=StartTime,regex=['([0-9\\.]+).*']).g1+format(args=atoi(string=parse_string_with_regex(string=StartTime,regex=['(-|\\+)([0-9]+)']).g2)/60,format=parse_string_with_regex(string=StartTime,regex=['.*(\\+|-)']).g1+"%02.0f00"),format=TimeFormat) 
        
        LET CurrentlyLoggedIn <= SELECT ExtractDomain(Antecedent=Antecedent) as Domain, ExtractLogonName(Antecedent=Antecedent) as LogonName, ExtractLogonID(data=Dependent) as CurrentLogonId FROM wmi(query="SELECT * FROM win32_loggedonuser", namespace="ROOT/CIMV2") WHERE LogonName =~ UserNameRegex
        
        // WMI Queries
        LET Sessions = SELECT FormatTime(StartTime=StartTime) as StartTimestamp,* FROM wmi(query="SELECT * FROM Win32_LogonSession", namespace="ROOT/CIMV2")
        
        LET Processes <= SELECT ExtractLogonID(data=Antecedent) as LogonID,count() as ProcessCount from wmi(query="SELECT * from Win32_SessionProcess", namespace="ROOT/CIMV2") GROUP by LogonID 
        
        LET CurrentSessions = SELECT *, { SELECT * FROM CurrentlyLoggedIn WHERE LogonID=CurrentLogonId AND Domain =~ DomainRegex AND LogonType =~ LogonTypeRegex } as LoginInfo, { SELECT * FROM Sessions WHERE LogonID=LogonId } as SessionInfo from Processes
        
        // Final query 
        SELECT timestamp(string=SessionInfo.StartTimestamp) as Timestamp,LoginInfo.LogonName as LogonName,LoginInfo.Domain as Domain,ProcessCount,SessionInfo.LogonType as LogonType,SessionInfo.LogonId as LogonID,SessionInfo.AuthenticationPackage as AuthenticationPackage from CurrentSessions 
        WHERE LogonName=~ UserNameRegex AND Domain =~ DomainRegex AND LogonType =~ LogonTypeRegex
        ORDER BY Timestamp DESC
     

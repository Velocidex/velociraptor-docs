name: Linux.Event.Network.Nethogs
author: 'Andreas Misje - @misje'
type: CLIENT_EVENT
description: |
  Monitor network bandwidth per process, using "nethogs". This artifact will
  list all processes that produces (non-local) network traffic on the client,
  leveraging the process tracker, and displays the bytes received and sent in
  the given time frame. A notebook suggestion gives you the total byte count as
  well.

  Note that the tool/package "nethogs" needs to be installed before calling this
  artifact. Set the paramater InstallNethogs to true in order to automatically
  install the package and its dependencies (Debian-based systems only).

  Short-lived processes that only run for less than one second will not be shown
  unless a process tracker is installed on the system (*.Events.TrackProcesses).

parameters:
  - name: InstallNethogs
    description: Install nethogs using apt-get
    type: bool
    default: false

precondition:
  SELECT * FROM info() where OS = 'linux'

sources:
    - query: |
       LET Hoggers = SELECT Process,
                            PID,
                            UID,
                            Sent,
                            Recv
         FROM foreach(
           row={
             SELECT *
             FROM execve(argv=['/usr/sbin/nethogs', '-t', '-v', '2'],
                         length=10000,
                         sep='\n\nRefreshing:\n')
           },
           query={
             SELECT timestamp(epoch=now()) AS Timestamp,
                    *
             FROM parse_records_with_regex(
               accessor='data',
               file=Stdout,
               regex='''^\s*(?P<Process>[^\t]+)/(?P<PID>\d+)/(?P<UID>\d+)\t(?P<Sent>\d+)\t(?P<Recv>\d+)''')
           })

       LET Result = SELECT
                           int(
                             int=PID) AS PID,
                           *
         FROM foreach(
           row={
             SELECT *
             FROM Hoggers
           },
           query={
             SELECT
                    PID,
                    Name,
                    CommandLine,
                    Cwd,
                    UID AS _UID,
                    Username,
                    StartTime,
                    if(
                      condition=EndTime.Unix < 0,
                      then=NULL,
                      else=EndTime) AS Endtime,
                    int(
                      int=Sent) AS Sent,
                    int(
                      int=Recv) AS Recv
             FROM process_tracker_pslist()
             WHERE Pid = PID
           })

       LET InstallDeps = SELECT *
         FROM if(
           condition=InstallNethogs,
           then={
             SELECT *
             FROM Artifact.Linux.Utils.InstallDeb(DebName='nethogs')
           })

       SELECT *
       FROM chain(a_install=InstallDeps,
                  b_result=Result)

      notebook:
        - type: vql_suggestion
          name: Total traffic
          template: |
               /*
               # Total traffic
               */
               SELECT
                      Name,
                      humanize(
                        bytes=sum(
                            item=Sent)) AS Sent,
                      humanize(
                        bytes=sum(
                            item=Recv)) AS Recv
               FROM source()
               GROUP BY Name

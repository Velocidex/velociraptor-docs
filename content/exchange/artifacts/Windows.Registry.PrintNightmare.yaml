name: Windows.Registry.PrintNightmare
author: Daksh Gajjar
description: |
   According to Microsoft, this vulnerability can only be exploited if the “NoWarningNoElevationOnInstall” key in the registry is set to 1.
   
   The artifact scans the device registry to check if the beforementioned key exists or not; if it is undefined or doesn’t exist, then the system is not vulnerable    to the PrintNightmare. Otherwise, the system is considered to be vulnerable to exploitation.
   
   This vulnerability can be exploited using the Evil Printer attack.
   
   The suggested VQL query looks for the registry values to find a registry key named “NoWarningNoElevationOnInstall”.

reference:
   - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527

type: CLIENT

precondition: SELECT OS From info() where OS = 'windows'

parameters:
  - name: SearchRegistryGlob
    description: Registry path
    default: \HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint\**

sources:
   - query: |
         SELECT  Name as KeyName,
            FullPath,
            Data.type as KeyType, 
            Data.value as KeyValue,
            Sys,
            ModTime as Modified
         FROM glob(globs=SearchRegistryGlob, accessor='registry')
         WHERE KeyType = "DWORD"
            AND KeyName =~ "NoWarningNoElevationOnInstall"
                  
column_types:
   - name: Modified
   - type: timestamp
